<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°ë“œë¯¼í„´ ì½”íŠ¸ ë°°ì • ì‹œìŠ¤í…œ (v5.1 - Fix)</title>
    <style>
        /* --- (CSSëŠ” v5ì™€ ë™ì¼) --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; padding: 20px; flex-direction: column; -webkit-font-smoothing: antialiased; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; }
        .global-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; background-color: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .global-controls .control-group { display: flex; align-items: center; gap: 8px; }
        .global-controls label { font-weight: bold; font-size: 0.9rem; }
        .global-controls button, .control-group button { padding: 10px 15px; background-color: #007aff; color: white; border: none; border-radius: 5px; font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .global-controls button:hover, .control-group button:hover { background-color: #0056b3; }
        .global-controls input[type="time"], .global-controls input[type="file"] { border: 1px solid #ccc; border-radius: 5px; padding: 5px 8px; }
        .global-controls input[type="file"] { display: none; }
        .global-controls #csvLoadButton { background-color: #34c759; }
        .global-controls #csvLoadButton:hover { background-color: #2a9e48; }
        /* [ì‚­ì œ] ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì œê±° */
        .global-controls #clearMasterTime { background-color: #eee; color: #555; padding: 5px 8px; font-size: 0.8rem; }
        .global-controls #clearMasterTime:hover { background-color: #ddd; }
        .courts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .court { position: relative; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 5px; background-color: #333; border: 12px solid #e0e0e0; border-radius: 5px; padding: 5px; }
        .court-number { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 40px; background-color: #555; color: white; border-radius: 20px; display: flex; justify-content: center; align-items: center; font-size: 1.1rem; font-weight: bold; z-index: 10; pointer-events: none; transition: background-color 0.3s; }
        .court-number.playing { background-color: #34c759; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 1.25rem; }
        .player-slot { background-color: #f0f0f0; color: #aaa; display: flex; justify-content: center; align-items: center; min-height: 80px; font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; user-select: none; z-index: 1; border: 2px dashed transparent; }
        .player-slot.filled { background-color: #fbc2c2; color: #c93a3a; font-weight: bold; }
        .player-slot.drag-over { background-color: #d4ffd4; border-color: #34c759; transform: scale(1.03); }
        .wait-item.dragging { opacity: 0.4; transform: scale(0.95); }
        .waitlist-section { background-color: #f2e8e8; padding: 20px; border-radius: 10px; }
        .waitlist-section h3 { margin: 0 0 20px 0; font-size: 1.5rem; color: #333; }
        .add-player-form { display: flex; gap: 10px; margin-bottom: 20px; }
        .add-player-form input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        .add-player-form button { padding: 10px 20px; background-color: #5a8d5a; color: white; border: none; border-radius: 5px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .add-player-form button:hover { background-color: #4a744a; }
        .waiting-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; list-style: none; padding: 0; margin: 0; }
        .wait-item { display: flex; justify-content: space-between; align-items: center; background: #fdf6f6; padding: 10px 15px; border-radius: 5px; border: 1px solid #e0c8c8; cursor: grab; transition: opacity 0.2s, transform 0.2s; }
        .wait-item:active { cursor: grabbing; }
        .wait-item .player-name { font-weight: bold; font-size: 1.1rem; color: #333; }
        .wait-item .wait-time { background: #eee; padding: 5px 8px; border-radius: 3px; font-size: 0.9rem; font-weight: bold; color: #555; min-width: 60px; text-align: right; }
        .wait-item .assign-btn { padding: 5px 10px; font-size: 0.8rem; background-color: #4a76c2; color: white; border: none; border-radius: 3px; cursor: pointer; margin-left: 5px; }
        .wait-item .assign-btn:hover { background-color: #3a5d9a; }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="global-controls">
            <div class="control-group">
                <button id="addCourtButton">â• ì½”íŠ¸ ì¶”ê°€</button>
            </div>
            
            <div class="control-group">
                <input type="file" id="csvFileInput" accept=".csv, text/csv">
                <button id="csvLoadButton" onclick="document.getElementById('csvFileInput').click();">
                    ğŸ“„ CSV ëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
            </div>
            
            <div class="control-group time-control">
                <label for="masterStartTime">ëŒ€í‘œ ì‹œì‘ ì‹œê°„:</label>
                <input type="time" id="masterStartTime">
                <button id="clearMasterTime" title="ëŒ€í‘œ ì‹œì‘ ì‹œê°„ ì§€ìš°ê¸°">âŒ</button>
            </div>
        </div>

        <div class="courts-container" id="courtsContainer">
            </div>
        
        <div class="waitlist-section">
            <h3>ëŒ€ê¸° ëª…ë‹¨ & ëŒ€ê¸° ì‹œê°„ í‘œì‹œ</h3>
            <div class="add-player-form">
                <input type="text" id="playerNameInput" placeholder="ëŒ€ê¸°ì ì´ë¦„ ì…ë ¥...">
                <button id="addPlayerButton">ëŒ€ê¸°ì—´ ì¶”ê°€</button>
            </div>
            <ul class="waiting-list" id="waitingList"></ul>
        </div>

    </div>

    <script>
        // --- JavaScript (v5.1 - Fix) ---

        // 1. í•„ìš”í•œ HTML ìš”ì†Œë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const playerNameInput = document.getElementById('playerNameInput');
        const addPlayerButton = document.getElementById('addPlayerButton');
        const waitingListElement = document.getElementById('waitingList');
        const courtsContainer = document.getElementById('courtsContainer');
        const addCourtButton = document.getElementById('addCourtButton');
        const masterStartTimeInput = document.getElementById('masterStartTime');
        const clearMasterTimeButton = document.getElementById('clearMasterTime');
        const csvFileInput = document.getElementById('csvFileInput');
        // [ì‚­ì œ] downloadListButton ìƒìˆ˜ ì‚­ì œ

        // 2. ë°ì´í„° ë³€ìˆ˜
        let waitingQueue = [];
        let nextId = 0;
        let courts = []; 

        // 3. (í•¨ìˆ˜) ëŒ€ê¸°ì—´ ëª©ë¡ ë Œë”ë§ (v5ì™€ ë™ì¼)
        function renderWaitingList() {
            waitingListElement.innerHTML = '';
            const now = Date.now();
            waitingQueue.forEach(player => {
                const elapsedSeconds = Math.floor((now - player.startTime) / 1000);
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}ì´ˆ`;
                const li = document.createElement('li');
                li.className = 'wait-item';
                li.setAttribute('draggable', 'true');
                li.dataset.playerId = player.id;
                li.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', player.id);
                    e.dataTransfer.effectAllowed = 'move';
                    li.classList.add('dragging'); 
                });
                li.addEventListener('dragend', () => { li.classList.remove('dragging'); });
                li.innerHTML = `
                    <span class="player-name">${player.name}</span>
                    <span class="wait-time">${formattedTime}</span>
                    <button class="assign-btn" data-player-id="${player.id}">ë°°ì •</button>
                `;
                waitingListElement.appendChild(li);
            });
        }
        
        // (í•¨ìˆ˜) ì½”íŠ¸ ìƒíƒœ ë Œë”ë§ (v5ì™€ ë™ì¼)
        function renderCourtStatus() {
            const now = Date.now();
            courts.forEach(court => {
                let display = 'ëŒ€ê¸°';
                let isPlaying = false;
                if (court.status === 'playing') {
                    const elapsedSeconds = Math.floor((now - court.startTime) / 1000);
                    const minutes = Math.floor(elapsedSeconds / 60);
                    const seconds = elapsedSeconds % 60;
                    display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    isPlaying = true;
                }
                const courtElement = document.getElementById(`court-${court.id}`);
                const numberSpan = courtElement.querySelector('.court-number');
                numberSpan.textContent = display;
                numberSpan.classList.toggle('playing', isPlaying);
            });
        }

        // 4. (í•¨ìˆ˜) ëŒ€ê¸°ì—´ì— ìƒˆ í”Œë ˆì´ì–´ ì¶”ê°€ (v5ì™€ ë™ì¼)
        function addPlayerToQueue(name, startTime) {
            if (!name || name.trim() === "") return;
            const newPlayer = { id: nextId++, name: name.trim(), startTime: startTime };
            waitingQueue.push(newPlayer);
        }
        
        // 4-1. (í•¨ìˆ˜) 'ëŒ€ê¸°ì—´ ì¶”ê°€' ë²„íŠ¼ í•¸ë“¤ëŸ¬ (v5ì™€ ë™ì¼)
        function handleAddPlayerButton() {
            const name = playerNameInput.value;
            if (name.trim() === "") { alert("í”Œë ˆì´ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!"); return; }
            let startTime = Date.now(); 
            const masterTimeValue = masterStartTimeInput.value;
            if (masterTimeValue) {
                const [hours, minutes] = masterTimeValue.split(':').map(Number);
                const manualStartTime = new Date();
                manualStartTime.setHours(hours, minutes, 0, 0);
                if (manualStartTime.getTime() > Date.now()) { alert("ëŒ€í‘œ ì‹œì‘ ì‹œê°„ì€ í˜„ì¬ ì‹œê°„ë³´ë‹¤ ë¯¸ë˜ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
                startTime = manualStartTime.getTime();
            }
            addPlayerToQueue(name, startTime);
            playerNameInput.value = '';
            renderWaitingList();
        }

        // (í•¨ìˆ˜) ì½”íŠ¸ ìƒíƒœ ì²´í¬ (v5ì™€ ë™ì¼)
        function checkCourtStatus(courtId) {
            const court = courts.find(c => c.id == courtId);
            if (!court) return;
            const playerCount = court.players.filter(p => p !== null).length;
            if (playerCount === 4 && court.status === 'waiting') {
                court.status = 'playing';
                court.startTime = Date.now();
            } else if (playerCount < 4 && court.status === 'playing') {
                court.status = 'waiting';
                court.startTime = null;
            }
            renderCourtStatus();
        }

        // 5. [ìˆ˜ì •] (í•¨ìˆ˜) í”Œë ˆì´ì–´ë¥¼ ìŠ¬ë¡¯ì— ë°°ì • (ë²„ê·¸ ìˆ˜ì •ë¨)
        function assignPlayerById(playerId, targetSlot) {
            const playerIndex = waitingQueue.findIndex(p => p.id == playerId);
            if (playerIndex === -1) return;
            const player = waitingQueue[playerIndex];

            let slotToFill = targetSlot; // ë“œë˜ê·¸ ì‹œ targetSlot (DOMìš”ì†Œ) / ë²„íŠ¼ í´ë¦­ ì‹œ null
            
            if (!slotToFill) { // ë²„íŠ¼ í´ë¦­ ì‹œ (slotToFillì´ nullì¼ ë•Œ)
                const allSlots = document.querySelectorAll('.player-slot');
                for (const slot of allSlots) {
                    if (!slot.classList.contains('filled')) {
                        slotToFill = slot; // ë¹ˆ ìŠ¬ë¡¯ì„ ì°¾ì•„ì„œ slotToFillì— í• ë‹¹
                        break;
                    }
                }
            }
            
            if (!slotToFill) { alert("ëª¨ë“  ì½”íŠ¸ê°€ ê½‰ ì°¼ìŠµë‹ˆë‹¤!"); return; }
            if (slotToFill.classList.contains('filled')) { alert("ì´ë¯¸ í”Œë ˆì´ì–´ê°€ ë°°ì •ëœ ìŠ¬ë¡¯ì…ë‹ˆë‹¤."); return; }

            // --- [í•µì‹¬ ë²„ê·¸ ìˆ˜ì •] ---
            // 'targetSlot'ì´ ì•„ë‹Œ, ë¹ˆ ìŠ¬ë¡¯ì„ ì°¾ì€ 'slotToFill' ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨
            const courtId = slotToFill.dataset.court; 
            const slotIndex = parseInt(slotToFill.dataset.slot, 10) - 1;
            // ------------------------
            
            const court = courts.find(c => c.id == courtId);
            court.players[slotIndex] = player.name;
            
            slotToFill.classList.add('filled');
            slotToFill.textContent = player.name;
            slotToFill.dataset.playerName = player.name; 

            waitingQueue.splice(playerIndex, 1);
            renderWaitingList();
            
            checkCourtStatus(courtId);
        }
        
        // 6. (í•¨ìˆ˜) ì½”íŠ¸ ìŠ¬ë¡¯ ë¹„ìš°ê¸° (v5ì™€ ë™ì¼)
        function clearSlot(event) {
            const slot = event.target; 
            if (slot.classList.contains('filled')) {
                const playerName = slot.dataset.playerName;
                if (confirm(`'${playerName}'ë‹˜ì˜ ë°°ì •ì„ ì·¨ì†Œí•˜ê³  ëŒ€ê¸°ì—´ë¡œ ëŒë ¤ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    const courtId = slot.dataset.court;
                    const slotIndex = parseInt(slot.dataset.slot, 10) - 1;
                    const court = courts.find(c => c.id == courtId);
                    court.players[slotIndex] = null; 
                    addPlayerToQueue(playerName, Date.now());
                    slot.classList.remove('filled');
                    slot.textContent = `í”Œë ˆì´ì–´ ${parseInt(slot.dataset.slot, 10)}`;
                    delete slot.dataset.playerName;
                    renderWaitingList(); 
                    checkCourtStatus(courtId);
                }
            }
        }

        // 7. (í•¨ìˆ˜) ìƒˆ ì½”íŠ¸ ì¶”ê°€ (v5ì™€ ë™ì¼)
        function addCourt() {
            const newCourtId = courts.length + 1;
            const newCourtData = { id: newCourtId, players: [null, null, null, null], status: 'waiting', startTime: null };
            courts.push(newCourtData);
            const newCourt = document.createElement('div');
            newCourt.className = 'court';
            newCourt.id = `court-${newCourtId}`;
            newCourt.innerHTML = `
                <span class="court-number">ëŒ€ê¸°</span>
                <div class="player-slot" data-court="${newCourtId}" data-slot="1">í”Œë ˆì´ì–´ 1</div>
                <div class="player-slot" data-court="${newCourtId}" data-slot="2">í”Œë ˆì´ì–´ 2</div>
                <div class="player-slot" data-court="${newCourtId}" data-slot="3">í”Œë ˆì´ì–´ 3</div>
                <div class="player-slot" data-court="${newCourtId}" data-slot="4">í”Œë ˆì´ì–´ 4</div>
            `;
            courtsContainer.appendChild(newCourt);
        }
        
        // 8. (í•¨ìˆ˜) CSV íŒŒì¼ ì½ê¸° (v5ì™€ ë™ì¼)
        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split('\n');
                const startTime = Date.now();
                let addedCount = 0;
                lines.forEach(line => {
                    const name = line.trim();
                    if (name) { addPlayerToQueue(name, startTime); addedCount++; }
                });
                renderWaitingList();
                alert(`${addedCount}ëª…ì˜ í”Œë ˆì´ì–´ê°€ ëŒ€ê¸°ì—´ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                csvFileInput.value = ''; 
            };
            reader.onerror = () => { alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); };
            reader.readAsText(file);
        }
        
        // 9. [ì‚­ì œ] downloadWaitlistAsCsv í•¨ìˆ˜ ì‚­ì œ

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° --- (ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆë§Œ ì‚­ì œ)
        addPlayerButton.addEventListener('click', handleAddPlayerButton);
        playerNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddPlayerButton(); });
        addCourtButton.addEventListener('click', addCourt);
        clearMasterTimeButton.addEventListener('click', () => { masterStartTimeInput.value = ''; });
        csvFileInput.addEventListener('change', handleCsvUpload);
        // [ì‚­ì œ] downloadListButton ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì‚­ì œ

        waitingListElement.addEventListener('click', (e) => {
            if (e.target.classList.contains('assign-btn')) {
                const playerId = e.target.dataset.playerId;
                assignPlayerById(playerId, null);
            }
        });
        courtsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('player-slot')) {
                clearSlot(e);
            }
        });
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ (v5ì™€ ë™ì¼)
        courtsContainer.addEventListener('dragover', (e) => {
            e.preventDefault(); 
            const targetSlot = e.target;
            if (targetSlot.classList.contains('player-slot') && !targetSlot.classList.contains('filled')) {
                targetSlot.classList.add('drag-over');
                e.dataTransfer.dropEffect = 'move';
            } else { e.dataTransfer.dropEffect = 'none'; }
        });
        courtsContainer.addEventListener('dragleave', (e) => {
            if (e.target.classList.contains('player-slot')) {
                e.target.classList.remove('drag-over');
            }
        });
        courtsContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            const targetSlot = e.target;
            targetSlot.classList.remove('drag-over'); 
            if (targetSlot.classList.contains('player-slot') && !targetSlot.classList.contains('filled')) {
                const playerId = e.dataTransfer.getData('text/plain');
                assignPlayerById(playerId, targetSlot);
            }
        });

        // --- ì´ˆê¸°í™” í•¨ìˆ˜ --- (v5ì™€ ë™ì¼)
        function initializeApp() {
            for (let i = 0; i < 4; i++) { addCourt(); }
            waitingQueue = [
                { id: nextId++, name: 'ë°•ì„±ì¤€', startTime: Date.now() - 10000 },
                { id: nextId++, name: 'ê°•ì¤€ì‹œ', startTime: Date.now() - 20000 },
                { id: nextId++, name: 'ê³ ë„í•œ', startTime: Date.now() - 30000 },
            ];
            renderWaitingList();
            renderCourtStatus();
        }

        // --- ë©”ì¸ ë£¨í”„ --- (v5ì™€ ë™ì¼)
        setInterval(() => {
            renderWaitingList();
            renderCourtStatus();
        }, 1000);
        
        // ì•± ì‹¤í–‰
        initializeApp();

    </script>
</body>
</html>
